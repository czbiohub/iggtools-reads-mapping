

rule _dbs:
    input:
        expand(PROJ_DIR + "/4_midas/{bt2_combo}/db/repgenomes.species", bt2_combo = BT2_COMBO)


rule build_bowtie2_dbs:
    input:
        PROJ_DIR + "/4_midas/{bt2_combo}/db/genomes.tsv"
    output:
        PROJ_DIR + "/4_midas/{bt2_combo}/db/repgenomes.species"
    params:
        species_ids = PROJ_DIR + "/4_midas/{bt2_combo}/db/species_ids",
        midas_db_dir = PROJ_DIR + "/4_midas/{bt2_combo}/db"
    threads:
        config["threads"]
    shell:
        """
        tail -n +2 {input} | awk '{{print $2}}' > {params.species_ids}

        python -m iggtools build_bowtie2_indexes \
            --midas_iggdb {params.midas_db_dir} --num_cores {threads} \
            --bt2_indexes_name repgenomes --species_list {params.species_ids} \
            --bt2_indexes_dir {params.midas_db_dir}
        """


rule _snps:
    input:
        expand(PROJ_DIR + "/4_midas/{bt2_combo}/out/art_{bt2_combo}_{sim_cov}X/snps/" + str(config["species_id"]) + ".snps.tsv.lz4",
            bt2_combo = BT2_COMBO, sim_cov = SIM_COV_LIST)


rule run_snps:
    input:
        species = PROJ_DIR + "/4_midas/{bt2_combo}/db/repgenomes.species",
        r1 = PROJ_DIR + "/3_reads/cov_{sim_cov}_1.fastq",
        r2 = PROJ_DIR + "/3_reads/cov_{sim_cov}_2.fastq"
    output:
        PROJ_DIR + "/4_midas/{bt2_combo}/out/art_{bt2_combo}_{sim_cov}X/snps/" + str(config["species_id"]) + ".snps.tsv.lz4"
    params:
        sample_name = "art_{bt2_combo}_{sim_cov}X",
        midas_db_dir = PROJ_DIR + "/4_midas/{bt2_combo}/db",
        midas_out_dir = PROJ_DIR + "/4_midas/{bt2_combo}/out",
    threads:
        config["threads"]
    shell:
        """
        python -m iggtools midas_run_snps --sample {params.sample_name} \
            -1 {input.r1} -2 {input.r2} --midas_iggdb {params.midas_db_dir} \
            --prebuilt_bowtie2_indexes {params.midas_db_dir}/repgenomes \
            --prebuilt_bowtie2_species {input.species} \
            --marker_depth=-1 --num_cores {threads} \
            {params.midas_out_dir} &> {params.midas_out_dir}/{params.sample_name}_run_snps.log
        """
